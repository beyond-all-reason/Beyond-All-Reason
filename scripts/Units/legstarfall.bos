#define TA			// This is a TA script

#include "sfxtype.h"
#include "exptype.h"

piece
	turretHeadingPivot,
	turretPitchPivot1,
	barrel2,
	barrel6,
	barrel5,
	barrel4,
	barrel3,
	barrel7,
	barrel1,
	barrelSleeve1,
	barrelSleeve2,
	barrelSleeve6,
	barrelSleeve5,
	barrelSleeve4,
	barrelSleeve3,
	barrelSleeve7,
	turret,
	armourPlating1,
	armourPlating4,
	armourPlating3,
	turretPitchPivot2,
	armourPlating2,
	base,
	powerCell1,
	powerCell3,
	powerCell2,
	powerCell5,
	powerCell4,
	piping1,
	barrelSpinPivot,
	pipingStrut1,
	shellCasing,
	shellHead,
	flare1,
	flare2,
	flare3,
	flare4,
	flare5,
	flare6,
	flare7,
	barrelBackSmoke,
	baseSmoke1,
	baseSmoke2
;

static-var whichBarrel, revolverCount, last_heading, last_pitch, shotcount, restore_delay, issmoking, ischarging, isspooling;

// Signal definitions
#define SIG_AIM				2
#define SIG_FIRE			4
#define SIG_POWERING		16

#define SMOKEPIECE base
#include "smokeunit_thread_nohit.h"

Create()
{
	turn turretPitchPivot1 to x-axis <-45> now; 
	turn turretPitchPivot2 to x-axis <0> now; 
	turn barrelBackSmoke to z-axis <0> now;
	turn barrelBackSmoke to y-axis <180> now;

	move powerCell1 to y-axis [-12] now;
	move powerCell2 to y-axis [-12] now;
	move powerCell3 to y-axis [-12] now;
	move powerCell4 to y-axis [-12] now;
	move powerCell5 to y-axis [-12] now;

	whichBarrel = 0;
	restore_delay = 5;
	issmoking = 0;
	ischarging = 0;
	isspooling = 0;

	last_heading = -1000000;
	last_pitch = 0;
	return (0);
}

PowerUp(){
	emit-sfx 1024 + 2 from shellCasing;
	show shellHead;
	show shellCasing;
	if(isspooling == 1){
		while (isspooling < 50){
			shotcount = shotcount + 1;
			call-script lua_UnitScriptLight(13, shotcount);
			call-script lua_UnitScriptLight(14, shotcount);
			call-script lua_UnitScriptLight(15, shotcount);
			call-script lua_UnitScriptLight(16, shotcount);
			call-script lua_UnitScriptLight(17, shotcount);
			isspooling = isspooling + 1;
			sleep 100;
		}
		sleep 1;
	}
}

Smoking(){
	if(issmoking == 1){
		hide shellCasing;
		hide shellHead;
		while (issmoking < 56){
			emit-sfx 1024+6 from baseSmoke1;
			emit-sfx 1024+6 from baseSmoke2;
			emit-sfx 1024+6 from barrelBackSmoke;
			emit-sfx 1024+6 from barrelBackSmoke;

			emit-sfx 1024+8 from flare1;
			emit-sfx 1024+8 from flare2;
			emit-sfx 1024+8 from flare3;
			emit-sfx 1024+8 from flare4;
			emit-sfx 1024+8 from flare5;
			emit-sfx 1024+8 from flare6;
			emit-sfx 1024+8 from flare7;
			issmoking = issmoking + 1;
			sleep 500;
		}
	}
	if (issmoking == 55){
		issmoking = 0;
	}
	sleep 1;
}

lua_UnitScriptLight(lightIndex, count) 
{
	return 0;
}
static-var Stunned;
RestoreAfterDelay()
{

	sleep restore_delay;
    if (Stunned) {
        return (1);
    }
	// move powerCell1 to y-axis [-12] speed [12];
	// move powerCell2 to y-axis [-12] speed [12];
	// move powerCell3 to y-axis [-12] speed [12];
	// move powerCell4 to y-axis [-12] speed [12];
	// move powerCell5 to y-axis [-12] speed [12];
	// set-signal-mask 0;
}

AimPrimary(heading, pitch)
{
	signal SIG_AIM;
	set-signal-mask SIG_AIM;

	turn turretHeadingPivot to y-axis heading speed <15>;
	if (pitch > <70>){
		move turretPitchPivot1 to z-axis [-4] speed [5];
		turn turretPitchPivot1 to x-axis (-0.5 * pitch) speed <15>;
		turn turretPitchPivot2 to x-axis (-1 * pitch) speed <20>;
	}
	else {
		move turretPitchPivot1 to z-axis [0] speed [5];
		turn turretPitchPivot1 to x-axis (-1 * pitch) speed <15>;
		turn turretPitchPivot2 to x-axis <0> speed <20>;
	}

	wait-for-turn turretHeadingPivot around y-axis;
	wait-for-turn turretPitchPivot1 around x-axis;
	wait-for-turn turretPitchPivot2 around x-axis;

	last_heading = heading;
	last_pitch = pitch;

	start-script RestoreAfterDelay();
	return (1);
}

FirePrimary() {
	whichBarrel = 0;
	issmoking = 0;
	revolverCount = 0;
	shotcount = shotcount + 1;

	spin barrelSpinPivot around z-axis speed <1800> accelerate <18>;
	isspooling = 1;
	emit-sfx 4096 + 1 from base;
	start-script PowerUp();
	move powerCell1 to y-axis [0] speed [12];
	sleep 1000;
	move powerCell2 to y-axis [0] speed [12];
	sleep 1000;
	move powerCell3 to y-axis [0] speed [12];
	sleep 1000;
	move powerCell4 to y-axis [0] speed [12];
	sleep 1000;
	move powerCell5 to y-axis [0] speed [12];
	sleep 1000;
	stop-spin barrelSpinPivot around z-axis decelerate <9>;

	// FirePrimary controls animation right after firing
	// but after 1 second, AimPrimary should regain control over spindle animation
	// and last_primary_heading and last_primary_pitch should be reset
	signal SIG_FIRE;
	set-signal-mask SIG_FIRE;
	sleep 1000;
	last_heading = -1000000;
	last_pitch = 0;
}

Shot1(zero) {
	if(whichBarrel == 3 OR whichBarrel == 6){
		emit-sfx 1024 + 1 from barrelBackSmoke;
		emit-sfx 1024 + 2 from shellCasing;
		explode shellCasing type FALL | NOHEATCLOUD;
	}

	if(whichBarrel == 6){
		//barrels
		call-script lua_UnitScriptLight(1, shotcount);
		call-script lua_UnitScriptLight(2, shotcount);
		call-script lua_UnitScriptLight(3, shotcount);
		call-script lua_UnitScriptLight(4, shotcount);
		call-script lua_UnitScriptLight(5, shotcount);
		call-script lua_UnitScriptLight(6, shotcount);
		call-script lua_UnitScriptLight(7, shotcount);
		//exhaust cells
		call-script lua_UnitScriptLight(18, shotcount);
		call-script lua_UnitScriptLight(19, shotcount);
		call-script lua_UnitScriptLight(20, shotcount);
	}

	if(revolverCount == 1){
		move powerCell1 to y-axis [-12] speed [1000];
	}
	if(revolverCount == 3){
		move powerCell2 to y-axis [-12] speed [1000];
	}
	if(revolverCount == 5){
		move powerCell3 to y-axis [-12] speed [1000];
	}
	if(revolverCount == 7){
		move powerCell4 to y-axis [-12] speed [1000];
	}
	if(revolverCount == 8){
		move powerCell5 to y-axis [-12] speed [1000];
	}

	if (revolverCount == 8){
		isspooling = 0;
		issmoking = 1;
		start-script Smoking();
	}

	if(revolverCount == 0){
		//do something with powercells
		if(whichBarrel == 0){
			move barrel1 to z-axis [-5] now;
			emit-sfx 1024 + 0  from flare1;
			sleep 1;
			move barrel1 to z-axis [0] speed [5];
			whichBarrel = 1;
		}
		else if(whichBarrel == 1){
			move barrel2 to z-axis [-5] now;
			emit-sfx 1024 + 0  from flare2;
			sleep 1;
			move barrel2 to z-axis [0] speed [5];
			whichBarrel = 2;
		}
		else if(whichBarrel == 2){
			move barrel3 to z-axis [-5] now;
			emit-sfx 1024 + 0  from flare3;
			sleep 1;
			move barrel3 to z-axis [0] speed [5];
			whichBarrel = 3;
		}
		else if(whichBarrel == 3){
			move barrel4 to z-axis [-5] now;
			emit-sfx 1024 + 0  from flare4;
			sleep 1;
			move barrel4 to z-axis [0] speed [5];
			whichBarrel = 4;
		}
		else if(whichBarrel == 4){
			move barrel5 to z-axis [-5] now;
			emit-sfx 1024 + 0  from flare5;
			sleep 1;
			move barrel5 to z-axis [0] speed [5];
			whichBarrel = 5;
		}
		else if(whichBarrel == 5){
			move barrel6 to z-axis [-5] now;
			emit-sfx 1024 + 0  from flare6;
			sleep 1;
			move barrel6 to z-axis [0] speed [5];
			whichBarrel = 6;
		}
		else if(whichBarrel == 6){
			move barrel7 to z-axis [-5] now;
			emit-sfx 1024 + 0  from flare7;
			sleep 1;
			move barrel7 to z-axis [0] speed [5];
			whichBarrel = 0;
			revolverCount = 1;
		}
	}

	else if(revolverCount == 1){
		//do something with powercells
		if(whichBarrel == 0){
			move barrel1 to z-axis [-10] now;
			emit-sfx 1024 + 0  from flare1;
			sleep 1;
			move barrel1 to z-axis [0] speed [5];
			whichBarrel = 1;
		}
		else if(whichBarrel == 1){
			move barrel2 to z-axis [-10] now;
			emit-sfx 1024 + 0  from flare2;
			sleep 1;
			move barrel2 to z-axis [0] speed [5];
			whichBarrel = 2;
		}
		else if(whichBarrel == 2){
			move barrel3 to z-axis [-10] now;
			emit-sfx 1024 + 0  from flare3;
			sleep 1;
			move barrel3 to z-axis [0] speed [5];
			whichBarrel = 3;
		}
		else if(whichBarrel == 3){
			move barrel4 to z-axis [-10] now;
			emit-sfx 1024 + 0  from flare4;
			sleep 1;
			move barrel4 to z-axis [0] speed [5];
			whichBarrel = 4;
		}
		else if(whichBarrel == 4){
			move barrel5 to z-axis [-10] now;
			emit-sfx 1024 + 0  from flare5;
			sleep 1;
			move barrel5 to z-axis [0] speed [5];
			whichBarrel = 5;
		}
		else if(whichBarrel == 5){
			move barrel6 to z-axis [-10] now;
			emit-sfx 1024 + 0  from flare6;
			sleep 1;
			move barrel6 to z-axis [0] speed [5];
			whichBarrel = 6;
		}
		else if(whichBarrel == 6){
			move barrel7 to z-axis [-10] now;
			emit-sfx 1024 + 0  from flare7;
			sleep 1;
			move barrel7 to z-axis [0] speed [5];
			whichBarrel = 0;
			revolverCount = 2;
		}
	}

	else if(revolverCount == 2){
		//do something with powercells
		if(whichBarrel == 0){
			move barrel1 to z-axis [-15] now;
			emit-sfx 1024 + 0  from flare1;
			sleep 1;
			move barrel1 to z-axis [0] speed [5];
			whichBarrel = 1;
		}
		else if(whichBarrel == 1){
			move barrel2 to z-axis [-15] now;
			emit-sfx 1024 + 0  from flare2;
			sleep 1;
			move barrel2 to z-axis [0] speed [5];
			whichBarrel = 2;
		}
		else if(whichBarrel == 2){
			move barrel3 to z-axis [-15] now;
			emit-sfx 1024 + 0  from flare3;
			sleep 1;
			move barrel3 to z-axis [0] speed [5];
			whichBarrel = 3;
		}
		else if(whichBarrel == 3){
			move barrel4 to z-axis [-15] now;
			emit-sfx 1024 + 0  from flare4;
			sleep 1;
			move barrel4 to z-axis [0] speed [5];
			whichBarrel = 4;
		}
		else if(whichBarrel == 4){
			move barrel5 to z-axis [-15] now;
			emit-sfx 1024 + 0  from flare5;
			sleep 1;
			move barrel5 to z-axis [0] speed [5];
			whichBarrel = 5;
		}
		else if(whichBarrel == 5){
			move barrel6 to z-axis [-15] now;
			emit-sfx 1024 + 0  from flare6;
			sleep 1;
			move barrel6 to z-axis [0] speed [5];
			whichBarrel = 6;
		}
		else if(whichBarrel == 6){
			move barrel7 to z-axis [-15] now;
			emit-sfx 1024 + 0  from flare7;
			sleep 1;
			move barrel7 to z-axis [0] speed [5];
			whichBarrel = 0;
			revolverCount = 3;
		}
	}

	else if(revolverCount == 3){
		//do something with powercells
		if(whichBarrel == 0){
			move barrel1 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare1;
			sleep 1;
			move barrel1 to z-axis [0] speed [5];
			whichBarrel = 1;
		}
		else if(whichBarrel == 1){
			move barrel2 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare2;
			sleep 1;
			move barrel2 to z-axis [0] speed [5];
			whichBarrel = 2;
		}
		else if(whichBarrel == 2){
			move barrel3 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare3;
			sleep 1;
			move barrel3 to z-axis [0] speed [5];
			whichBarrel = 3;
		}
		else if(whichBarrel == 3){
			move barrel4 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare4;
			sleep 1;
			move barrel4 to z-axis [0] speed [5];
			whichBarrel = 4;
		}
		else if(whichBarrel == 4){
			move barrel5 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare5;
			sleep 1;
			move barrel5 to z-axis [0] speed [5];
			whichBarrel = 5;
		}
		else if(whichBarrel == 5){
			move barrel6 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare6;
			sleep 1;
			move barrel6 to z-axis [0] speed [5];
			whichBarrel = 6;
		}
		else if(whichBarrel == 6){
			move barrel7 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare7;
			sleep 1;
			move barrel7 to z-axis [0] speed [5];
			whichBarrel = 0;
			revolverCount = 4;
		}
	}

	else if(revolverCount == 4){
		//do something with powercells
		if(whichBarrel == 0){
			move barrel1 to z-axis [-25] now;
			emit-sfx 1024 + 0  from flare1;
			sleep 1;
			move barrel1 to z-axis [0] speed [5];
			whichBarrel = 1;
		}
		else if(whichBarrel == 1){
			move barrel2 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare2;
			sleep 1;
			move barrel2 to z-axis [0] speed [5];
			whichBarrel = 2;
		}
		else if(whichBarrel == 2){
			move barrel3 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare3;
			sleep 1;
			move barrel3 to z-axis [0] speed [5];
			whichBarrel = 3;
		}
		else if(whichBarrel == 3){
			move barrel4 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare4;
			sleep 1;
			move barrel4 to z-axis [0] speed [5];
			whichBarrel = 4;
		}
		else if(whichBarrel == 4){
			move barrel5 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare5;
			sleep 1;
			move barrel5 to z-axis [0] speed [5];
			whichBarrel = 5;
		}
		else if(whichBarrel == 5){
			move barrel6 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare6;
			sleep 1;
			move barrel6 to z-axis [0] speed [5];
			whichBarrel = 6;
		}
		else if(whichBarrel == 6){
			move barrel7 to z-axis [-20] now;
			emit-sfx 1024 + 0  from flare7;
			sleep 1;
			move barrel7 to z-axis [0] speed [5];
			whichBarrel = 0;
			revolverCount = 5;
		}
	}

	else if(revolverCount == 5){
		//do something with powercells
		if(whichBarrel == 0){
			move barrel1 to z-axis [-25] now;
			emit-sfx 1024 + 0  from flare1;
			sleep 1;
			move barrel1 to z-axis [0] speed [5];
			whichBarrel = 1;
		}
		else if(whichBarrel == 1){
			move barrel2 to z-axis [-25] now;
			emit-sfx 1024 + 0  from flare2;
			sleep 1;
			move barrel2 to z-axis [0] speed [5];
			whichBarrel = 2;
		}
		else if(whichBarrel == 2){
			move barrel3 to z-axis [-25] now;
			emit-sfx 1024 + 0  from flare3;
			sleep 1;
			move barrel3 to z-axis [0] speed [5];
			whichBarrel = 3;
		}
		else if(whichBarrel == 3){
			move barrel4 to z-axis [-25] now;
			emit-sfx 1024 + 0  from flare4;
			sleep 1;
			move barrel4 to z-axis [0] speed [5];
			whichBarrel = 4;
		}
		else if(whichBarrel == 4){
			move barrel5 to z-axis [-25] now;
			emit-sfx 1024 + 0  from flare5;
			sleep 1;
			move barrel5 to z-axis [0] speed [5];
			whichBarrel = 5;
		}
		else if(whichBarrel == 5){
			move barrel6 to z-axis [-25] now;
			emit-sfx 1024 + 0  from flare6;
			sleep 1;
			move barrel6 to z-axis [0] speed [5];
			whichBarrel = 6;
		}
		else if(whichBarrel == 6){
			move barrel7 to z-axis [-25] now;
			emit-sfx 1024 + 0  from flare7;
			sleep 1;
			move barrel7 to z-axis [0] speed [5];
			whichBarrel = 0;
			revolverCount = 6;
		}
	}

	else if(revolverCount == 6){
		//do something with powercells
		if(whichBarrel == 0){
			move barrel1 to z-axis [-30] now;
			emit-sfx 1024 + 0  from flare1;
			sleep 1;
			move barrel1 to z-axis [0] speed [5];
			whichBarrel = 1;
		}
		else if(whichBarrel == 1){
			move barrel2 to z-axis [-30] now;
			emit-sfx 1024 + 0  from flare2;
			sleep 1;
			move barrel2 to z-axis [0] speed [5];
			whichBarrel = 2;
		}
		else if(whichBarrel == 2){
			move barrel3 to z-axis [-30] now;
			emit-sfx 1024 + 0  from flare3;
			sleep 1;
			move barrel3 to z-axis [0] speed [5];
			whichBarrel = 3;
		}
		else if(whichBarrel == 3){
			move barrel4 to z-axis [-30] now;
			emit-sfx 1024 + 0  from flare4;
			sleep 1;
			move barrel4 to z-axis [0] speed [5];
			whichBarrel = 4;
		}
		else if(whichBarrel == 4){
			move barrel5 to z-axis [-30] now;
			emit-sfx 1024 + 0  from flare5;
			sleep 1;
			move barrel5 to z-axis [0] speed [5];
			whichBarrel = 5;
		}
		else if(whichBarrel == 5){
			move barrel6 to z-axis [-30] now;
			emit-sfx 1024 + 0  from flare6;
			sleep 1;
			move barrel6 to z-axis [0] speed [5];
			whichBarrel = 6;
		}
		else if(whichBarrel == 6){
			move barrel7 to z-axis [-30] now;
			emit-sfx 1024 + 0  from flare7;
			sleep 1;
			move barrel7 to z-axis [0] speed [5];
			whichBarrel = 0;
			revolverCount = 7;
		}
	}

	else if(revolverCount == 7){
		//do something with powercells
		if(whichBarrel == 0){
			move barrel1 to z-axis [-32] now;
			emit-sfx 1024 + 0  from flare1;
			sleep 1;
			move barrel1 to z-axis [0] speed [5];
			whichBarrel = 1;
		}
		else if(whichBarrel == 1){
			move barrel2 to z-axis [-32] now;
			emit-sfx 1024 + 0  from flare2;
			sleep 1;
			move barrel2 to z-axis [0] speed [5];
			whichBarrel = 2;
		}
		else if(whichBarrel == 2){
			move barrel3 to z-axis [-32] now;
			emit-sfx 1024 + 0  from flare3;
			sleep 1;
			move barrel3 to z-axis [0] speed [5];
			whichBarrel = 3;
		}
		else if(whichBarrel == 3){
			move barrel4 to z-axis [-32] now;
			emit-sfx 1024 + 0  from flare4;
			sleep 1;
			move barrel4 to z-axis [0] speed [5];
			whichBarrel = 4;
		}
		else if(whichBarrel == 4){
			move barrel5 to z-axis [-32] now;
			emit-sfx 1024 + 0  from flare5;
			sleep 1;
			move barrel5 to z-axis [0] speed [5];
			whichBarrel = 5;
		}
		else if(whichBarrel == 5){
			move barrel6 to z-axis [-32] now;
			emit-sfx 1024 + 0  from flare6;
			sleep 1;
			move barrel6 to z-axis [0] speed [5];
			whichBarrel = 6;
		}
		else if(whichBarrel == 6){
			move barrel7 to z-axis [-32] now;
			emit-sfx 1024 + 0  from flare7;
			sleep 1;
			move barrel7 to z-axis [0] speed [5];
			whichBarrel = 0;
			revolverCount = 8;
		}
	}

	else if(revolverCount == 8){
		//do something with powercells
		if(whichBarrel == 0){
			move barrel1 to z-axis [-35] now;
			emit-sfx 1024 + 0  from flare1;
			sleep 1;
			move barrel1 to z-axis [0] speed [5];
			whichBarrel = 1;
		}
		else if(whichBarrel == 1){
			move barrel2 to z-axis [-35] now;
			emit-sfx 1024 + 0  from flare2;
			sleep 1;
			move barrel2 to z-axis [0] speed [5];
			whichBarrel = 2;
		}
		else if(whichBarrel == 2){
			move barrel3 to z-axis [-35] now;
			emit-sfx 1024 + 0  from flare3;
			sleep 1;
			move barrel3 to z-axis [0] speed [5];
			whichBarrel = 3;
		}
		else if(whichBarrel == 3){
			move barrel4 to z-axis [-35] now;
			emit-sfx 1024 + 0  from flare4;
			sleep 1;
			move barrel4 to z-axis [0] speed [5];
			whichBarrel = 4;
		}
		else if(whichBarrel == 4){
			move barrel5 to z-axis [-35] now;
			emit-sfx 1024 + 0  from flare5;
			sleep 1;
			move barrel5 to z-axis [0] speed [5];
			whichBarrel = 5;
		}
		else if(whichBarrel == 5){
			move barrel6 to z-axis [-35] now;
			emit-sfx 1024 + 0  from flare6;
			sleep 1;
			move barrel6 to z-axis [0] speed [5];
			whichBarrel = 6;
		}
		else if(whichBarrel == 6){
			move barrel7 to z-axis [-35] now;
			emit-sfx 1024 + 0  from flare7;
			sleep 1;
			move barrel7 to z-axis [0] speed [5];
			whichBarrel = 0;
			revolverCount = 0;
		}
	}

}

QueryPrimary(piecenum)
{
	if(whichBarrel == 0){
		pieceNum = flare1;
	}
	else if(whichBarrel == 1){
		pieceNum = flare2;
	}
	else if(whichBarrel == 2){
		pieceNum = flare3;
	}
	else if(whichBarrel == 3){
		pieceNum = flare4;
	}
	else if(whichBarrel == 4){
		pieceNum = flare5;
	}
	else if(whichBarrel == 5){
		pieceNum = flare6;
	}
	else if(whichBarrel == 6){
		pieceNum = flare7;
	}

}

AimFromPrimary(piecenum)
{
	piecenum = turretHeadingPivot;
}

AimWeapon2(){
	return (0);
}

FireWeapon2(){
	return(1);
}

SweetSpot(piecenum)
{
	piecenum = base;
}

Killed(severity, corpsetype)
{
	if( severity <= 25 )
	{
		corpsetype = 1 ;
		return(corpsetype);
	}
	if( severity <= 50 )
	{
		corpsetype = 2 ;
		return(corpsetype);
	}
	corpsetype = 3 ;
	return(corpsetype);
}
