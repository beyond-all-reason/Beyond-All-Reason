
#include "../recoil_common_includes.h"

piece
    base,
    jammerBase,
    cloaklight,
    jamDishA,
    jamDishB,
    jamDishC,
    jamDishD,
    dishTower,
    dishAStrut,
    dishA,
    dishABot1,
    dishABot2,
    dishATop1,
    dishATop2,
    dishBstrut,
    dishB,
    dishBBot1,
    dishBBot2,
    dishBTop1,
    dishBTop2,
    dishCstrut,
    dishC,
    dishCBot1,
    dishCBot2,
    dishCTop1,
    dishCTop2,
    dishDStrut,
    dishD,
    dishDBot1,
    dishDBot2,
    dishDTop1,
    dishDTop2,
    radarlight1,
    radarlight2,
    radarlight3,
    radarlight4,
    radarBase,
    wake,
    bow;
static-var  oldHead;
static-var recently_damaged, desired_activation;
static-var  Stunned;


// Signal definitions
#define SIGNAL_MOVE 1
#define SIGNAL_TURNON 4
#define SIGNAL_OFF 8

#define RB_MASS 30
#define RB_LENGTH 6
#define RB_WIDTH 3
#define RB_PITCH_SPEED 200
#define RB_PITCH_ACCELERATION 10
#define RB_ROLL_ACCELERATION 6
#define RB_WAKE_PIECE wake
#define RB_WAKE_PERIOD 6 
#define RB_WAKE_CEG 1024 + 1
#define RB_ONHIT start-script OffOnHit();
#define RB_BOWSPLASH_PIECE bow
#define RB_BOWSPLASH_CEG 1024 + 0
#include "../bar_ships_common.h"


Create()
{

	// turn jammer to off position
    hide cloaklight;
	move jamDishA to x-axis [1] now;
    move jamDishA to z-axis [-1] now;
    move jamDishB to x-axis [1] now;
    move jamDishB to z-axis [1] now;
    move jamDishC to x-axis [-1] now;
    move jamDishC to z-axis [1] now;
    move jamDishD to x-axis [-1] now;
    move jamDishD to z-axis [-1] now;

	// turn radar to off position
    hide radarlight1;
    hide radarlight2;
    hide radarlight3;
    hide radarlight4;

    move dishATop2 to z-axis [1] now;
    move dishABot2 to z-axis [1] now;
    turn dishATop2 to x-axis <-30> now;
    turn dishABot2 to x-axis <30> now;
    move dishATop1 to z-axis [1] now;
    move dishABot1 to z-axis [1] now;
    turn dishATop1 to x-axis <-10> now;
    turn dishABot1 to x-axis <10> now;

    move dishBTop2 to x-axis [-1] now;
    move dishBBot2 to x-axis [-1] now;
    turn dishBTop2 to z-axis <-30> now;
    turn dishBBot2 to z-axis <30> now;
    move dishBTop1 to x-axis [-1] now;
    move dishBBot1 to x-axis [-1] now;
    turn dishBTop1 to z-axis <-10> now;
    turn dishBBot1 to z-axis <10> now;

    move dishCTop2 to z-axis [-1] now;
    move dishCBot2 to z-axis [-1] now;
    turn dishCTop2 to x-axis <30> now;
    turn dishCBot2 to x-axis <-30> now;
    move dishCTop1 to z-axis [-1] now;
    move dishCBot1 to z-axis [-1] now;
    turn dishCTop1 to x-axis <10> now;
    turn dishCBot1 to x-axis <-10> now;

    move dishDTop2 to x-axis [1] now;
    move dishDBot2 to x-axis [1] now;
    turn dishDTop2 to z-axis <30> now;
    turn dishDBot2 to z-axis <-30> now;
    move dishDTop1 to x-axis [1] now;
    move dishDBot1 to x-axis [1] now;
    turn dishDTop1 to z-axis <10> now;
    turn dishDBot1 to z-axis <-10> now;

	//init functions

	recently_damaged = 0;
	desired_activation = 1;
	start-script InitRockBoat();
	SLEEP_UNTIL_UNITFINISHED;
	start-script BoatPhysics();

	//turn on jammer
	show cloaklight;
    move jamDishA to x-axis [0] speed [3];
    move jamDishA to z-axis [0] speed [3];
    move jamDishB to x-axis [0] speed [3];
    move jamDishB to z-axis [0] speed [3];
    move jamDishC to x-axis [0] speed [3];
    move jamDishC to z-axis [0] speed [3];
    move jamDishD to x-axis [0] speed [3];
    move jamDishD to z-axis [0] speed [3];
	spin jammerBase around y-axis speed <75> accelerate <1>;

	//turn on radar
	turn dishATop1 to x-axis <0> speed <30>;
    turn dishABot1 to x-axis <0> speed <30>;
    sleep 100;
    turn dishBTop1 to z-axis <0> speed <30>;
    turn dishBBot1 to z-axis <0> speed <30>;
    sleep 100;
    turn dishCTop1 to x-axis <0> speed <30>;
    turn dishCBot1 to x-axis <0> speed <30>;
    sleep 100;
    turn dishDTop1 to z-axis <0> speed <30>;
    turn dishDBot1 to z-axis <0> speed <30>;
    wait-for-turn dishABot1 around x-axis;

    move dishATop1 to z-axis [0] speed [3];
    move dishABot1 to z-axis [0] speed [3];
    sleep 100;
    move dishBTop1 to x-axis [0] speed [3];
    move dishBBot1 to x-axis [0] speed [3];
    sleep 100;
    move dishCTop1 to z-axis [0] speed [3];
    move dishCBot1 to z-axis [0] speed [3];
    sleep 100;
    move dishDTop1 to x-axis [0] speed [3];
    move dishDBot1 to x-axis [0] speed [3];
    wait-for-move dishABot1 along z-axis;

    turn dishATop2 to x-axis <0> speed <30>;
    turn dishABot2 to x-axis <0> speed <30>;
    sleep 100;
    turn dishBTop2 to z-axis <0> speed <30>;
    turn dishBBot2 to z-axis <0> speed <30>;
    sleep 100;
    turn dishCTop2 to x-axis <0> speed <30>;
    turn dishCBot2 to x-axis <0> speed <30>;
    sleep 100;
    turn dishDTop2 to z-axis <0> speed <30>;
    turn dishDBot2 to z-axis <0> speed <30>;
    wait-for-turn dishABot2 around x-axis;

    move dishATop2 to z-axis [0] speed [3];
    move dishABot2 to z-axis [0] speed [3];
    spin dishA around z-axis speed <-100> accelerate <1>;
    sleep 200;
    move dishBTop2 to x-axis [0] speed [3];
    move dishBBot2 to x-axis [0] speed [3];
    spin dishB around x-axis speed <-100> accelerate <1>;
    sleep 200;
    move dishCTop2 to z-axis [0] speed [3];
    move dishCBot2 to z-axis [0] speed [3];
    spin dishC around z-axis speed <-100> accelerate <1>;
    sleep 100;
    move dishDTop2 to x-axis [0] speed [3];
    move dishDBot2 to x-axis [0] speed [3];
    spin dishD around x-axis speed <-100> accelerate <1>;
    wait-for-move dishABot2 along z-axis;

    spin dishTower around y-axis speed <100> accelerate <2>;
    show radarlight1;
    show radarlight2;
    show radarlight3;
    show radarlight4;


}

Lights()
{
	if (!Stunned) {
	    emit-sfx 1024 + 2 from dishAStrut;
	}
	sleep 2500;
	start-script Lights();
}

Activate()
{
	signal SIGNAL_TURNON;
	set-signal-mask SIGNAL_TURNON;
	desired_activation = 1;
	// if we are in this function, the unit is already on
	// implied set ACTIVATION to 1;
	// turn off if unit is in the recently_damaged state
	// this turn off action calls the Deactivate function
	if( recently_damaged == 1)
	{
		set ACTIVATION to 0;
		return(0);
	}
	//jammer activation
	spin jammerBase around y-axis speed <75> accelerate <1>;
    show cloaklight;
	//radar activation
    turn dishATop1 to x-axis <0> speed <30>;
    turn dishABot1 to x-axis <0> speed <30>;
    sleep 100;
    turn dishBTop1 to z-axis <0> speed <30>;
    turn dishBBot1 to z-axis <0> speed <30>;
    sleep 100;
    turn dishCTop1 to x-axis <0> speed <30>;
    turn dishCBot1 to x-axis <0> speed <30>;
    sleep 100;
    turn dishDTop1 to z-axis <0> speed <30>;
    turn dishDBot1 to z-axis <0> speed <30>;
    wait-for-turn dishABot1 around x-axis;

    move dishATop1 to z-axis [0] speed [3];
    move dishABot1 to z-axis [0] speed [3];
    sleep 100;
    move dishBTop1 to x-axis [0] speed [3];
    move dishBBot1 to x-axis [0] speed [3];
    sleep 100;
    move dishCTop1 to z-axis [0] speed [3];
    move dishCBot1 to z-axis [0] speed [3];
    sleep 100;
    move dishDTop1 to x-axis [0] speed [3];
    move dishDBot1 to x-axis [0] speed [3];
    wait-for-move dishABot1 along z-axis;

    turn dishATop2 to x-axis <0> speed <30>;
    turn dishABot2 to x-axis <0> speed <30>;
    sleep 100;
    turn dishBTop2 to z-axis <0> speed <30>;
    turn dishBBot2 to z-axis <0> speed <30>;
    sleep 100;
    turn dishCTop2 to x-axis <0> speed <30>;
    turn dishCBot2 to x-axis <0> speed <30>;
    sleep 100;
    turn dishDTop2 to z-axis <0> speed <30>;
    turn dishDBot2 to z-axis <0> speed <30>;
    wait-for-turn dishABot2 around x-axis;

    move dishATop2 to z-axis [0] speed [3];
    move dishABot2 to z-axis [0] speed [3];
    spin dishA around z-axis speed <-100> accelerate <1>;
    sleep 200;
    move dishBTop2 to x-axis [0] speed [3];
    move dishBBot2 to x-axis [0] speed [3];
    spin dishB around x-axis speed <-100> accelerate <1>;
    sleep 200;
    move dishCTop2 to z-axis [0] speed [3];
    move dishCBot2 to z-axis [0] speed [3];
    spin dishC around z-axis speed <-100> accelerate <1>;
    sleep 100;
    move dishDTop2 to x-axis [0] speed [3];
    move dishDBot2 to x-axis [0] speed [3];
    spin dishD around x-axis speed <-100> accelerate <1>;
    wait-for-move dishABot2 along z-axis;

    spin dishTower around y-axis speed <100> accelerate <2>;
    show radarlight1;
    show radarlight2;
    show radarlight3;
    show radarlight4;
	start-script Lights();
}

Deactivate()
{
	// get PRINT(0, desired_activation,desired_activation,get GAME_FRAME);
	// no easy way to tell if an on-off action is 
	// script/gadget controlled or user controlled
	// assume a deactivate command is a user command 
	// if the unit has not been recently damaged
	// However, we need to wait a few frames, 
	// unit_paralyze_on_off deactivates this unit before it is 
	// stunned, so it is actually turned off, but we need to wait to see if the
	// unit is "damaged" by stun.
	sleep 100;
	if (recently_damaged == 0)
	{
		//set desired state if deactivated and not recently damaged
		desired_activation = 0;
	}
	signal SIGNAL_TURNON;
	set-signal-mask SIGNAL_TURNON;
	// jammer deactivation
    hide cloaklight;
    stop-spin jammerBase around y-axis decelerate <2>;
	// radar deactivation
    stop-spin dishTower around y-axis decelerate <10>;

    move dishATop2 to z-axis [1]    speed [3];
    move dishABot2 to z-axis [1]    speed [3];
    turn dishATop2 to x-axis <-30>  speed <30>;
    turn dishABot2 to x-axis <30>   speed <30>;
    move dishATop1 to z-axis [1]    speed [3];
    move dishABot1 to z-axis [1]    speed [3];
    turn dishATop1 to x-axis <-10>  speed <30>;
    turn dishABot1 to x-axis <10>   speed <30>;

    move dishBTop2 to x-axis [-1]   speed [3];
    move dishBBot2 to x-axis [-1]   speed [3];
    turn dishBTop2 to z-axis <-30>  speed <30>;
    turn dishBBot2 to z-axis <30>   speed <30>;
    move dishBTop1 to x-axis [-1]   speed [3];
    move dishBBot1 to x-axis [-1]   speed [3];
    turn dishBTop1 to z-axis <-10>  speed <30>;
    turn dishBBot1 to z-axis <10>   speed <30>;

    move dishCTop2 to z-axis [-1]   speed [3];
    move dishCBot2 to z-axis [-1]   speed [3];
    turn dishCTop2 to x-axis <30>   speed <30>;
    turn dishCBot2 to x-axis <-30>  speed <30>;
    move dishCTop1 to z-axis [-1]   speed [3];
    move dishCBot1 to z-axis [-1]   speed [3];
    turn dishCTop1 to x-axis <10>   speed <30>;
    turn dishCBot1 to x-axis <-10>  speed <30>;

    move dishDTop2 to x-axis [1]    speed [3];
    move dishDBot2 to x-axis [1]    speed [3];
    turn dishDTop2 to z-axis <30>   speed <30>;
    turn dishDBot2 to z-axis <-30>  speed <30>;
    move dishDTop1 to x-axis [1]    speed [3];
    move dishDBot1 to x-axis [1]    speed [3];
    turn dishDTop1 to z-axis <10>   speed <30>;
    turn dishDBot1 to z-axis <-10>  speed <30>;

	stop-spin dishA around z-axis decelerate <2>;
	stop-spin dishB around x-axis decelerate <2>;
	stop-spin dishC around z-axis decelerate <2>;
	stop-spin dishD around x-axis decelerate <2>;

    hide radarlight1;
    hide radarlight2;
    hide radarlight3;
    hide radarlight4;

}


SetStunned(State)
{
    Stunned = State;
	if (Stunned) {
	    start-script Deactivate();
	} else {
	    set ACTIVATION to desired_activation;
	}
}

OffOnHit()
{
	signal SIGNAL_OFF;
	set-signal-mask SIGNAL_OFF;
	hide cloaklight;
	hide radarlight1;
	hide radarlight2;
	hide radarlight3;
	hide radarlight4;
	recently_damaged = 1;
	set ACTIVATION to 0; // turn off unit
	sleep 8000; //hardcoded time to stay off after being hit
	recently_damaged = 0;
	set ACTIVATION to desired_activation;
}




StartMoving(reversing)
{

}

StopMoving()
{

}



Killed(severity, corpsetype)
{
	if( severity <= 25 )
	{
		corpsetype = 1 ;
		explode base type BITMAPONLY | NOHEATCLOUD;
		explode jammerBase type FIRE | SMOKE | FALL | NOHEATCLOUD;
		explode wake type BITMAPONLY | NOHEATCLOUD;
		return(corpsetype);
	}
	if( severity <= 50 )
	{
		corpsetype = 2 ;
		explode base type BITMAPONLY | NOHEATCLOUD;
		explode radarBase type FIRE | SMOKE | FALL | NOHEATCLOUD;
		explode wake type FIRE | SMOKE | FALL | NOHEATCLOUD;
		return(corpsetype);
	}
	if( severity <= 99 )
	{
		corpsetype = 3 ;
		explode base type BITMAPONLY | NOHEATCLOUD;
		explode radarBase type EXPLODE_ON_HIT | SMOKE | FALL | NOHEATCLOUD;
		explode wake type FIRE | SMOKE | FALL | NOHEATCLOUD;
		return(corpsetype);
	}
	corpsetype = 3 ;
		explode base type BITMAPONLY | NOHEATCLOUD;
		explode radarBase type EXPLODE_ON_HIT | FIRE | SMOKE | FALL | NOHEATCLOUD;
		explode wake type EXPLODE_ON_HIT | FIRE | FALL | NOHEATCLOUD;
	return corpsetype;
}
