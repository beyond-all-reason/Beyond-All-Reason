name: Lint and Type Check

on:
  pull_request:
    branches: [ master, main ]
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  lint:
    name: Lux Check & Lint
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Lux
        run: |
          wget https://github.com/lumen-oss/lux/releases/download/v0.15.0/lx_0.15.0_x86_64.tar.gz
          tar -xvf lx_0.15.0_x86_64.tar.gz
          sudo mv usr/bin/lx /usr/local/bin/lx
          rm lx_0.15.0_x86_64.tar.gz
          rm -rf usr

      - name: Install Dependencies
        run: lx update

      - name: Run Type Check (lx check)
        run: lx check

      - name: Run Linter (lx lint)
        run: lx lint

      - name: Verify Formatting (lx fmt)
        run: |
          lx fmt
          # Check if any files were modified by lx fmt
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Code is not formatted. Please run 'lx fmt' locally and push the changes."
            git status --porcelain
            git diff
            exit 1
          else
            echo "Code is correctly formatted."
          fi

